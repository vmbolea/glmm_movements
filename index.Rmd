---
title: "GLMMs"
author: "vmbolea"
date: "`r Sys.Date()`"
output: 
    html_document:
        code_folding: hide
        toc: true               
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data preparation

The data is coming from file "data/data_identity.xlsx".

```{r echo= TRUE, message=FALSE, warning = FALSE}
library(dplyr)
library(ggplot2)

#read data
data <- readxl::read_xlsx(path = "data/data_identity.xlsx",
                          sheet = "DESPLAZAMIENTO",
                          range =  "C1:V120")

print(data, n = 120)
```

The script "data_preparation.R" is used to create the curated data to be used in the models.


```{r message=FALSE, warning = FALSE}

source("data_preparation.R")

df <- read.csv("data/my_data.csv")

print(data_, n = 90)

df <- data_
```


# Linear mixed models(GLMM)

To investigate the factors influencing leadership probability, we fitted Generalized Linear Mixed Models (GLMMs) with a binomial error distribution and a logit link function, utilizing the lme4 package.

We constructed the response variable as a two-column matrix binding the number of times an individual acted as a leader versus the number of times they acted as a follower. We ran separate models for each of the two leadership contexts defined previously: 

- 1) movements toward feeding trees and defense-related movements. To test our predictions regarding sex differences, we included sex as the fixed effect in the models for both contexts.

- 2) to evaluate the influence of female reproductive state, we analyzed a subset of the data containing only female subjects, with reproductive status (cycling, lactating, or with dependents) serving as the fixed predictor. 

In all models, we included subject identity as a random intercept to control for repeated measures and potential pseudo-replication arising from sampling the same individuals multiple times. We determined the statistical significance of the fixed effects by performing Likelihood Ratio Tests (LRT), comparing the full models against null models that included only the random intercept, setting the significance threshold at p < .05.

```{r echo = FALSE, message=FALSE, warning = FALSE}

#load packages
library(lme4)
library(multcomp)

# Load your dataset
 df <- read.csv("data/my_data.csv")

#compute relative contribution of each category per month
df <- df %>%
  dplyr::group_by(context, month, sex) %>%
  dplyr::mutate(n_category = dplyr::n()) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(context, month) %>%
  dplyr::mutate(rel_contrib = n_category / max(n_category))

df <- df %>%
  mutate(prop_leader = n_leader / (n_leader + n_follower))

df$ID <- as.factor(df$ID)
df$sex <- as.factor(df$sex)
df$repro_status <- as.factor(df$repro_status)

```

## Formula for the first model

The model function for predictions where the number of times each individual moved toward as a given context (Feeding or Defense) as leader and as follower per month was added as a two‐vector response variable and the fixed predictor is given by the argument predictor (sex or reproductive status).

```{r echo = TRUE, message=FALSE, warning = FALSE}

run_model_leader_prop <- function(data, predictor, context_name){
  
  cat("\nRunning models for context:", context_name, "and predictor:", predictor, "\n")
  
  # Subset context
  dat <- subset(data, context == context_name)
  
  if(predictor == "repro_status"){
    
    dat <- dat |>
      dplyr::filter(sex == "F")
  }
  
  # Ensure ID and predictor are factors
  dat$ID <- as.factor(dat$ID)
  dat[[predictor]] <- as.factor(dat[[predictor]])
  
  # --- Model 1: leader/follower counts (two-vector response) ---
  formula1 <- as.formula(paste0("cbind(n_leader, n_follower) ~ ", predictor, " + (1|ID)"))
  model1 <- glmer(formula1,
                  family = binomial,
                  data = dat)
  
  # Null model
  formula_null1 <- as.formula("cbind(n_leader, n_follower) ~ (1|ID)")
  null1 <- glmer(formula_null1,
                 family = binomial,
                 data = dat)
  
  # Likelihood ratio test
  lrt1 <- anova(null1, model1, test = "Chisq")
  
  #confidence interval
  ci <- confint(model1, method = "Wald")  
  
  # output list
  out_list <- list(model = model1, summary_model = summary(model1), ci = ci, lrt = lrt1)

  #post hoc Tukey if predictor is reproductive state
  if(predictor == "repro_status"){
    posthoc <- glht(model1, linfct = mcp(repro_status = "Tukey"))
    out_list <- c(out_list, list(posthoc = posthoc))
  }
  
  return(out_list)
}

```


## Formula for the second model

The model function for predictions where the number of times each individual moved toward as a given context (Feeding or Defense) as front and as back part of the followers per month was added as a two‐vector response variable and the fixed predictor is given by the argument predictor (sex or reproductive status).

```{r echo = TRUE, message=FALSE, warning = FALSE}

run_model_order_index <- function(data, predictor, context_name) {
  
  cat("\nRunning models for context:", context_name, "and predictor:", predictor, "\n")
  
  #subset by context
  dat <- subset(data, context == context_name)
  
  if(predictor == "repro_status"){
    
    dat <- dat |>
      dplyr::filter(sex == "F")
  }
  
  #ensure ID and predictor are factors
  dat$ID <- as.factor(dat$ID)
  dat[[predictor]] <- as.factor(dat[[predictor]])
  
  # --- Model 2: front/back counts (two-vector response) ---
  formula2 <- as.formula(paste0("cbind(n_front, n_back) ~ ", predictor, " + (1|ID)"))
  model2 <- glmer(formula2,
                  family = binomial,
                  data = dat)
  
  # Null model
  formula_null2 <- as.formula("cbind(n_front, n_back) ~ (1|ID)")
  null2 <- glmer(formula_null2,
                 family = binomial,
                 data = dat)
  

  #likelihood ratio test
  lrt2 <- anova(null2, model2)
  
  #confidence interval
  ci <- confint(model2, method = "Wald")  
  
  # output list
  out_list <- list(model = model2, summary_model = summary(model2), ci = ci, lrt = lrt2)

  #post hoc Tukey if predictor is reproductive state
  if(predictor == "repro_status"){
    posthoc <- glht(model2, linfct = mcp(repro_status = "Tukey"))
    out_list <- c(out_list, list(posthoc = posthoc))
  }
  
  
  return(out_list)
}

```


## Formula to prepare table with statistics per model

```{r echo = TRUE, message=FALSE, warning = FALSE}


statistical_table <- function(model_list){

# Extraer coeficientes resumidos
coef_sum <- summary(model_list$model)$coefficients

# Extraer intervalos de confianza
ci <- confint(model_list$model, parm = "beta_", level = 0.95, method = "Wald")  # o confint.default si Wald

# Crear tabla
results_table <- data.frame(
  Predictor = rownames(coef_sum),
  β = coef_sum[, "Estimate"],
  SE = coef_sum[, "Std. Error"],
  Z = coef_sum[, "z value"],
  p = coef_sum[, "Pr(>|z|)"],
  CI_lower = ci[,1],
  CI_upper = ci[,2]
)

# Formatear 95% C.I. como una columna única
results_table$`95% C.I.` <- paste0("[", round(results_table$CI_lower, 3), ", ", round(results_table$CI_upper, 3), "]")

# Seleccionar columnas finales
results_table <- results_table[, c("Predictor", "β", "SE", "95% C.I.", "Z", "p")]
rownames(results_table) <- NULL

return(results_table)

}


```


# 1st prediction: predictor = sex and context = Feeding

## 1st model: proportion of leadership

```{r message=FALSE, warning = FALSE}

model1 <- run_model_leader_prop(df, predictor="sex", context_name="Feeding")

print(model1$summary_model)
print(model1$lrt)


```
Conclusions:

- There is no evidence of a sex effect on the probability of leading toward the feeding trees.

- Observed differences are likely due to individual variation rather than sex.

- Graphically, males and females should show similar proportions of leaders.

### Results table


```{r message=FALSE, warning = FALSE}

statistical_table(model_list = model1)


```

### Boxplot

```{r  message=FALSE, warning = FALSE}

# Filtramos solo el contexto Feeding
df_feeding <- subset(df, context == "Feeding")

# Boxplot
ggplot(df_feeding, aes(x = sex, y = prop_leader, fill = sex)) +
  geom_boxplot(width = 0.6, alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "red", size = 2) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "black") +
  theme_bw() +
  facet_wrap(~context) +
  labs(x = "Sex", y = "Proportion of monthly movements as leader") +
  scale_x_discrete(name = "Sex", labels = c("F" = "Female", "M" = "Male")) +
  scale_fill_manual(values = c("F" = "lightblue", "M" = "lightblue"))+
  theme(legend.position = "none")


```

## 2nd model: order index progression

```{r message=FALSE, warning = FALSE}

model2 <- run_model_order_index(df, predictor="sex", context_name="Feeding")

print(model2$summary_model)
print(model2$lrt)


```
Conclusions:

- Sex does not significantly influence feeding position (front vs. back) in this context.

- Individual differences play a larger role than sex in explaining variation in feeding behavior.

- There is no evidence that adding sex as a predictor improves the explanatory power of the model.

- Any apparent difference between males and females is small and not statistically supported.

### Results table


```{r message=FALSE, warning = FALSE}

statistical_table(model_list = model2)


```

### Barplot

```{r  message=FALSE, warning = FALSE}

# Crear un dataframe resumido por sexo y posición
df_bar <- df %>%
  filter(context == "Feeding") %>%  # filtrar solo Feeding
  group_by(sex, mean_poi_position,context) %>%
  summarise(n_movements = n(), .groups = "drop")


# Barplot vertical
ggplot(df_bar, aes(x = sex, y = n_movements, fill = mean_poi_position)) +
  geom_bar(stat = "identity", 
           position = "dodge",  # ancho entre barras
           width = 0.6,  # ancho de cada barra
           color = "black") +  # borde negro fino
  geom_hline(yintercept = 17, linetype = "solid") +  # Female
  geom_hline(yintercept = 5, linetype = "dashed") + # Male
  scale_fill_manual(values = c("Front" = "#FF9999", "Back" = "#99CCFF"),
                    name = "Follower position") +
  scale_y_continuous(name = "Number of movements") +
  scale_x_discrete(name = "Sex", labels = c("F" = "Female", "M" = "Male")) +
  theme_bw() +
  facet_wrap(~context) +
  theme(
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 11),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )


```

# 2nd prediction: predictor = reproductive status and context = Feeding

## 1st model: proportion of leadership

```{r message=FALSE, warning = FALSE}

model1 <- run_model_leader_prop(df, predictor="repro_status", context_name="Feeding")

print(model1$summary_model)
print(model1$posthoc)
print(model1$lrt)


```
Conclusions:

- Reproductive status had a significant effect on the probability of being a leader versus a follower during feeding.

- Individuals in the AFD reproductive status had a significantly higher likelihood of leading compared to AFC individuals.

- Individuals in the AFL reproductive status also had a significantly higher likelihood of leading compared to AFC individuals.

- There was no meaningful difference in leadership probability between AFL and AFD individuals.

- Model comparison confirmed that including reproductive status improved model fit relative to the null model.

### Results table

```{r message=FALSE, warning = FALSE}

statistical_table(model_list = model1)


```
### Boxplot

```{r  message=FALSE, warning = FALSE}

# Filtramos solo el contexto Feeding
df_females <- subset(df, sex == "F") |>
  subset(context == "Feeding")


ggplot(df_females, aes(x = repro_status, y = prop_leader, fill = repro_status)) +
  geom_boxplot(width = 0.6, alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "red", size = 2) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 2, fill = "black") +
  theme_bw() +
  facet_wrap(~context) +
  labs(x = "Reproductive status", y = "Proportion of movements as leader") +
  scale_fill_manual(values = c("AFC" = "lightblue", "AFD" = "lightblue", "AFL" = "lightblue"))+
  scale_x_discrete(name = "Reproductive Status", labels = c("AFC" = "Cycling", "AFD" = "Codependent", "AFL" = "Lactanting")) +
  theme(legend.position = "none")

```

## 2nd model: order index progression

```{r message=FALSE, warning = FALSE}

model2 <- run_model_order_index(df, predictor="repro_status", context_name="Feeding")

print(model2$summary_model)
print(model2$posthoc)
print(model2$lrt)


```
Conclusions:

- Reproductive status has a strong and statistically significant effect on feeding response position.

- Both AFD and AFL show higher front responses than AFC, with AFD showing the strongest effect.

- Individual differences contribute meaningfully to variation in responses.

### Results table

```{r message=FALSE, warning = FALSE}

statistical_table(model_list = model1)


```
### Barplot

```{r  message=FALSE, warning = FALSE}

#crear un dataframe resumido por repro status y posición
df_bar <- df_females %>%
  filter(context == "Feeding") %>%
  group_by(repro_status, mean_poi_position,context) %>%
  summarise(n_movements = n(), .groups = "drop")

df_bar <- rbind(df_bar, 
                data.frame(repro_status = "AFD", mean_poi_position = "Back", context = "Feeding", n_movements = 0)
                )


# Barplot vertical
ggplot(df_bar, aes(x = repro_status, y = n_movements, fill = mean_poi_position)) +
  geom_bar(stat = "identity", 
           position = "dodge",  # ancho entre barras
           width = 0.6,  # ancho de cada barra
           color = "black") +  # borde negro fino
  geom_hline(yintercept = 7, linetype = "dotted") +  # Cycling
  geom_hline(yintercept = 3, linetype = "solid") + # Codependent
  geom_hline(yintercept = 7, linetype = "dotdash") + # Lactating
  scale_fill_manual(values = c("Front" = "#FF9999", "Back" = "#99CCFF"),
                    name = "Follower position") +
  scale_y_continuous(name = "Number of movements") +
  scale_x_discrete(name = "Reproductive Status", labels = c("AFC" = "Cycling", "AFD" = "Codependent", "AFL" = "Lactanting")) +
  theme_minimal(base_size = 14) +
  theme(
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 11),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )
```

# 3rd prediction: predictor = sex and context = Defense

## 1st model: proportion of leadership

```{r message=FALSE, warning = FALSE}

model1 <- run_model_leader_prop(df, predictor="sex", context_name="Defense")

print(model1$summary_model)
print(model1$lrt)


```
Conclusions:

- Sex has a strong and statistically significant effect on defensive role.

- Males are substantially more likely to act as leaders during defense than females.

- Individual differences contribute meaningfully to variation in defensive behavior.


### Results table


```{r message=FALSE, warning = FALSE}

statistical_table(model_list = model1)


```

### Boxplot

```{r  message=FALSE, warning = FALSE}

# Filtramos solo el contexto Defense
df_defense <- subset(df, context == "Defense")

# Boxplot
ggplot(df_defense, aes(x = sex, y = prop_leader, fill = sex)) +
  geom_boxplot(width = 0.6, alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "red", size = 2) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "black") +
  theme_bw() +
  facet_wrap(~context) +
  labs(x = "Sex", y = "Proportion of monthly movements as leader") +
  scale_x_discrete(name = "Sex", labels = c("F" = "Female", "M" = "Male")) +
  scale_fill_manual(values = c("F" = "lightblue", "M" = "lightblue"))+
  theme(legend.position = "none")
```

## 2nd model: order index progression

```{r message=FALSE, warning = FALSE}

model2 <- run_model_order_index(df, predictor="sex", context_name="Defense")

print(model2$summary_model)
print(model2$lrt)


```

Conclusions:

- Sex has no detectable effect on the direction (front vs back) of defensive responses.

- Variation in defensive response direction is driven primarily by individual differences, not sex.

- In contrast to leader–follower defense, front–back positioning during defense is sex-independent.


### Results table

```{r message=FALSE, warning = FALSE}

statistical_table(model_list = model2)


```

### Barplot

```{r  message=FALSE, warning = FALSE}
# Crear un dataframe resumido por sexo y posición
df_bar <- df %>%
  filter(context == "Defense") %>%  # filtrar solo Feeding
  group_by(sex, mean_poi_position,context) %>%
  summarise(n_movements = n(), .groups = "drop")


# Barplot vertical
ggplot(df_bar, aes(x = sex, y = n_movements, fill = mean_poi_position)) +
  geom_bar(stat = "identity", 
           position = "dodge",  # ancho entre barras
           width = 0.6,  # ancho de cada barra
           color = "black") +  # borde negro fino
  geom_hline(yintercept = 17, linetype = "solid") +  # Female
  geom_hline(yintercept = 5, linetype = "dashed") + # Male
  scale_fill_manual(values = c("Front" = "#FF9999", "Back" = "#99CCFF"),
                    name = "Follower position") +
  scale_y_continuous(name = "Number of movements") +
  scale_x_discrete(name = "Sex", labels = c("F" = "Female", "M" = "Male")) +
  theme_bw() +
  facet_wrap(~context) +
  theme(
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 11),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )
```


